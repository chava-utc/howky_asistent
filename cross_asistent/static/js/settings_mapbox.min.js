window.addEventListener("load",()=>{function e(e){if(e){d.forEach(e=>e.classList.remove("btn_detail","text-white","cursor-not")),c.forEach(e=>e.removeAttribute("disabled"));const o=document.querySelector(`label[for='${e}']`);o.classList.add("btn_detail","text-white","cursor-not");const t=document.querySelector(`input#${e}`);t.setAttribute("disabled","disabled"),f="#000","dark-v11"===e&&(f="#fff"),localStorage.setItem("mapbox-last_layer",e)}}function o(e){w.setStyle("mapbox://styles/mapbox/"+e)}function t(){w.getSource("directions")&&(g=w.getSource("directions")._data)}function a(e){w.getCanvas().style.cursor=e}function n(e){h&&h.remove();let o=localStorage.getItem("data-color_rgb");h=new mapboxgl.Marker({color:o||"#3b71ca",draggable:!1}).setLngLat(e).addTo(w)}function i(e){const o=j.getAll();if($("#controlsIndic").addClass("show"),o.features.length>0){const e=o.features[0],t=turf.area(e),a=Math.round(100*t)/100,n=e.geometry.coordinates[0],i=turf.length(e,{units:"kilometers"}),r=Math.round(1e3*i*100)/100,s=turf.centroid(e);$("#controlsIndic .card-body p").html(`\n            <p><strong>Área:</strong> ${a} m²</p>\n            <p><strong>Perímetro:</strong> ${r} m</p>\n            <p><strong>Centroide:</strong> [${s.geometry.coordinates.map(e=>e.toFixed(5)).join(", ")}]</p>\n            <p><strong>Puntos del polígono:</strong></p>\n            <ol>${n.map(e=>`<li>[${e[0].toFixed(5)}, ${e[1].toFixed(5)}]</li>`).join("")}</ol>\n        `)}else $("#controlsIndic").removeClass("show"),$("#controlsIndic .card-body p").html(""),"draw.delete"!==e.type&&alert("Haz clic en el mapa para dibujar un polígono.")}var r="pk.eyJ1IjoiY2hhdmEtdXRjIiwiYSI6ImNtOTdqdm13cjA4ZGsyaW9rc2g0OGRmdWoifQ.oxLDSCy8_q3xLJNVtDHmDw",s=document.getElementById("map");const l=localStorage.getItem("mapbox-last_layer"),c=document.querySelectorAll("#offcanvasbody input[type='radio']"),d=document.querySelectorAll("#offcanvasbody label"),u=document.querySelector("#form_route"),m=u.querySelector("#origen"),p=u.querySelector("#destino");let g,f="#000",y=!1,v=!1;var h;const F=document.querySelector("#infoLateral"),b=bootstrap.Offcanvas.getInstance(F)||new bootstrap.Offcanvas(F);mapboxgl.accessToken=r;const w=new mapboxgl.Map({container:"map",style:"mapbox://styles/mapbox/streets-v12",center:[-100.93655,25.55701],zoom:16,maxZoom:20,minZoom:15,maxBounds:[[-100.9736,25.5142],[-100.9117,25.5735]]}),E=new mapboxgl.GeolocateControl({positionOPtions:{enableHighAccuracy:!0},trackUserLocation:!0,ShowUserHeading:!0});if(w.addControl(E),$("#switchTheme").click(function(){$("#switchTheme").is(":checked")?(f="#000",o("streets-v12"),e("streets-v12")):(f="#fff",o("dark-v11"),e("dark-v11"))}),s.classList.contains("map_editing")){v=!0;var k={black:"#000000",negro:"#000000",white:"#FFFFFF",blanco:"#FFFFFF",red:"#FF0000",rojo:"#FF0000",green:"#008000",verde:"#008000",blue:"#0000FF",azul:"#0000FF",yellow:"#FFFF00",amarillo:"#FFFF00",cyan:"#00FFFF",cian:"#00FFFF",magenta:"#FF00FF",magenta:"#FF00FF",gray:"#808080",gris:"#808080",darkgray:"#A9A9A9","gris oscuro":"#A9A9A9",lightgray:"#D3D3D3","gris claro":"#D3D3D3",dimgray:"#696969","gris tenue":"#696969",slategray:"#708090","gris pizarra":"#708090",cornflowerblue:"#6495ED","azul aciano":"#6495ED",darkred:"#8B0000","rojo oscuro":"#8B0000",lightgreen:"#90EE90","verde claro":"#90EE90",darkblue:"#00008B","azul oscuro":"#00008B",gold:"#FFD700",oro:"#FFD700",silver:"#C0C0C0",plata:"#C0C0C0",pink:"#FFC0CB",rosa:"#FFC0CB",orange:"#FFA500",naranja:"#FFA500",purple:"#800080",morado:"#800080",brown:"#A52A2A","marrón":"#A52A2A",violet:"#EE82EE",violeta:"#EE82EE",turquoise:"#40E0D0",turquesa:"#40E0D0",indigo:"#4B0082","índigo":"#4B0082",khaki:"#F0E68C",caqui:"#F0E68C",maroon:"#800000",granate:"#800000",olive:"#808000",oliva:"#808000",navy:"#000080","azul marino":"#000080",teal:"#008080","verde azulado":"#008080",salmon:"#FA8072","salmón":"#FA8072",goldenrod:"#DAA520","vara de oro":"#DAA520",chocolate:"#D2691E",chocolate:"#D2691E",coral:"#FF7F50",coral:"#FF7F50",aquamarine:"#7FFFD4",aguamarina:"#7FFFD4",fuchsia:"#FF00FF",fucsia:"#FF00FF",lavender:"#E6E6FA",lavanda:"#E6E6FA",beige:"#F5F5DC",beis:"#F5F5DC",azure:"#F0FFFF","cian claro":"#F0FFFF",ivory:"#FFFFF0",marfil:"#FFFFF0",linen:"#FAF0E6",lino:"#FAF0E6",plum:"#DDA0DD",ciruela:"#DDA0DD",orchid:"#DA70D6","orquídea":"#DA70D6",mintcream:"#F5FFFA","crema de menta":"#F5FFFA",seashell:"#FFF5EE",concha:"#FFF5EE",honeydew:"#F0FFF0","rocío de miel":"#F0FFF0",snow:"#FFFAFA",nieve:"#FFFAFA",blanchedalmond:"#FFEBCD","almendra blanqueada":"#FFEBCD",antiquewhite:"#FAEBD7","blanco antiguo":"#FAEBD7",skyblue:"#87CEEB","cielo azul":"#87CEEB",peachpuff:"#FFDAB9",durazno:"#FFDAB9",navajowhite:"#FFDEAD","blanco navajo":"#FFDEAD",wheat:"#F5DEB3",trigo:"#F5DEB3",peru:"#CD853F","perú":"#CD853F",tomato:"#FF6347",tomate:"#FF6347",lightblue:"#ADD8E6","azul claro":"#ADD8E6",lime:"#00FF00",lima:"#00FF00"};const e=$("#colorsList");for(let o in k)e.append(`<option value="${o}">`);function C(e){return k[e.toLowerCase()]||e}function L(){const e=$("[data-colorName]").val(),o=C(e);$("#colorHex").val(o),$("[data-colorPicker]").val(o)}$("[data-colorName]").on("input",L),$("[data-colorPicker]").on("input",function(){const e=$("[data-colorPicker]").val();$("[data-colorName]").addClass("active").val(e),$("#colorHex").val(e)}),$("#btnPoligon").on("click",function(){$("#esquinasPoligono").slideDown("slow")});const o=document.getElementById("btnPoligon"),t=document.getElementById("btnPoligonCancel"),a=["esquina1","esquina2","esquina3","esquina4"],n=["tomato","#3b71ca","lime","#d29c15"];let i=4,r=[],s=[],l=null,c=!1;function D(e){if(s.length<4){const o=n[s.length],t=new mapboxgl.Marker({color:o,draggable:!0}).setLngLat(e.lngLat).addTo(w).on("dragend",_);r.push(t),s.push(e.lngLat),document.getElementById(a[s.length-1]).classList.add("active"),document.getElementById(a[s.length-1]).value=`${e.lngLat.lng}, ${e.lngLat.lat}`}4===s.length&&(w.off("contextmenu",D),A(),o.classList.add("bg_red-blue"),o.classList.remove("bg_purple-blue"),o.innerHTML='Dibujar de nuevo <i class="fa-solid fa-trash-can ms-1"></i>',c=!0,$("#btnPoligonCancel").slideUp())}function x(){r.forEach(e=>e.remove()),r=[],s=[],c?(o.classList.remove("btn_detail","bg_red-blue"),o.classList.add("bg_purple-blue"),o.innerHTML='Borrar marcadores <i class="fa-solid fa-trash-can ms-1"></i>'):""===c&&(o.classList.remove("bg_purple-blue","bg_red-blue"),o.classList.add("btn_detail"),o.innerHTML='Dibujar Poligono <i class="fa-solid fa-draw-polygon ms-1"></i>'),l&&(w.getLayer(l.id+"_label")&&w.removeLayer(l.id+"_label"),w.getLayer(l.id)&&w.removeLayer(l.id),w.getSource(l.id)&&w.removeSource(l.id)),c=!1}function A(){const e=document.getElementById("nombreEdificio").value||"Nuevo Lugar",o=document.getElementById("colorHex").value||"#808080",t=[s[0].toArray(),s[1].toArray(),s[2].toArray(),s[3].toArray(),s[0].toArray()];w.getLayer("polygon_label")&&w.removeLayer("polygon_label"),w.getLayer("polygon")&&w.removeLayer("polygon"),w.getSource("polygon")&&w.removeSource("polygon");const a="polygon";w.addSource(a,{type:"geojson",data:{type:"Feature",geometry:{type:"Polygon",coordinates:[t]}}}),w.addLayer({id:a,type:"fill",source:a,layout:{},paint:{"fill-color":o,"fill-opacity":.5}}),w.addLayer({id:a+"_label",type:"symbol",source:a,layout:{"text-field":e,"text-size":14,"text-anchor":"center"},paint:{"text-color":f}}),l={id:a}}function _(){s=r.map(e=>e.getLngLat()),a.forEach((e,o)=>{document.getElementById(e).value=`${s[o].lng}, ${s[o].lat}`}),A()}function S(){i--,i>0?document.getElementById("poligonClicks").textContent=i:(w.off("contextmenu",S),setTimeout(()=>{$("#controlsIndic").removeClass("show"),i=4,document.getElementById("poligonClicks").textContent=i},2e3))}o.addEventListener("click",()=>{c=!0,v=!1,x(),$("#controlsIndic .card-header h6").html('<i class="fa-solid fa-draw-polygon me-1"></i>Dibujar Poligono:'),$("#controlsIndic .card-body p").html('Da <strong id="poligonClicks">4</strong> cliks derechos en el mapa... <br> Dibuja el poligono en sentido <u>Horario</u> <i class="fa-solid fa-arrow-rotate-right ms-1"></i>'),$("#controlsIndic").addClass("show"),w.on("contextmenu",S),w.on("contextmenu",D),$("#btnPoligonCancel").slideDown(),window.innerWidth<=800&&setTimeout(()=>{F.classList.contains("show")&&b.hide()},1e3)}),t.addEventListener("click",()=>{c="",x(),w.off("contextmenu",D),w.off("contextmenu",S),$("#controlsIndic").removeClass("show"),$("#btnPoligonCancel").slideUp(),$("#esquinasPoligono").slideUp("fast")});const d=document.getElementById("inputBtnDoor"),u=document.getElementById("puertaCordsEdificio");var I;let m=!0;function B(e){I&&I.remove(),I=new mapboxgl.Marker({color:"purple",draggable:!0}).setLngLat(e.lngLat).addTo(w).on("dragend",q),u.classList.add("active"),u.value=`${e.lngLat.lng}, ${e.lngLat.lat}`,d.classList.remove("bg_purple-blue"),d.classList.add("btn_detail"),m=!0,w.off("contextmenu",B),setTimeout(()=>{$("#controlsIndic").removeClass("show")},2e3)}function q(e){const o=I.getLngLat();u.value=`${o.lng}, ${o.lat}`}d.addEventListener("click",()=>{v=!1,m&&(s.length>4&&t.click(),d.classList.add("bg_purple-blue"),d.classList.remove("btn_detail"),w.on("contextmenu",B),$("#controlsIndic .card-header h6").html('<i class="fa-solid fa-location-dot me-1"></i>Punto de Entrada:'),$("#controlsIndic .card-body p").html("Da <strong>1</strong> clik derecho en el mapa... <br> Debe esta ubicada en el <strong>borde</strong>  del poligono y conectada con algun <strong>camino</strong>"),$("#controlsIndic").addClass("show")),m=!1,window.innerWidth<=800&&setTimeout(()=>{F.classList.contains("show")&&b.hide()},1e3)}),$("#checkIsmarker").change(function(){$(this).is(":checked")?($("#sizemarkerdiv").slideDown("fast"),$("[data-notmarker]").slideUp(),$('[for="puertaCordsEdificio"]').text("Ubicacion:")):($("#sizemarkerdiv").slideUp(),$("[data-notmarker]").slideDown(),$('[for="puertaCordsEdificio"]').text("Punto de entrada:"))}),$("#sizemarker").blur(function(){const e=parseFloat($("#sizemarker").attr("max")),o=parseFloat($("#sizemarker").attr("min"));let t=parseFloat($("#sizemarker").val());t>e?t=e:t<o&&(t=o),$("#sizemarker").val(t)})}F.addEventListener("hidden.bs.offcanvas",function(){y=!1}),$("#deletePleace").on("hidden.bs.modal",function(e){$("#btnDeletedPleace").hide(),$("[data-namePleace]").text("")}),w.addControl(new mapboxgl.NavigationControl);class P{constructor(){this._container=null}onAdd(e){this._container=document.createElement("div"),this._container.className="mapboxgl-ctrl mapboxgl-ctrl-group";const o=(e,o,t,a)=>{const n=document.createElement("button");return n.className="mapboxgl-ctrl-"+e,n.innerHTML=o,n.title=t,n.type="button",n.onclick=a,n},t=o("gmaps",'<div class="mapboxgl-ctrl-icon"><i class="fa-solid fa-map-location-dot"></i></div>',"Google Maps",()=>{document.querySelectorAll(".offcanvas.show").forEach(e=>{const o=bootstrap.Offcanvas.getInstance(e);o&&o.hide()});var e=new mdb.Modal(document.getElementById("beforeSend"));e.show()}),a=o("styles",'<i class="fa-solid fa-layer-group"></i>',"Cambiar Aspecto",()=>{document.querySelectorAll(".offcanvas.show").forEach(e=>{const o=bootstrap.Offcanvas.getInstance(e);o&&o.hide()});const e=new bootstrap.Offcanvas(document.querySelector("#offcanvasBottom"));e.show()}),n=o("route",'<div class="mapboxgl-ctrl-icon"><i class="fa-solid fa-route"></i></div>',"Como ir a...",()=>$("#controlsRoute").toggleClass("show"));if(this._container.appendChild(t),this._container.appendChild(a),this._container.appendChild(n),s.classList.contains("map_editing")){const e=o("newBuild",'<i class="fa-solid fa-building-flag"></i>',"Crear Nuevo Edificio",()=>{if($("#btnDeletedPleace").hide(),$("[data-namePleace]").text(""),v){$("#offcanvasContent input").removeClass("active is-invalid is-valid").val(""),$(".error.bg-danger").slideUp("fast"),document.getElementById("imagen_actual").src="/static/img/default_image.webp",$("#offcanvasContent #isNewEdif").val("new");const e=$("#uuid").data("new-uid");$("#uuid").removeClass("active").val(e),$("#namecolor").addClass("active").val("gray"),$("#colorPicker").addClass("active").val("#808080"),x(),$('[for="fotoEdificio"]').html('Subir foto <i class="fa-regular fa-image ms-1"></i>'),$("#fotoEdificio").attr("required",!0),tinymce.get("textTiny").setContent(""),$("#ismarker").val("False"),$("#checkIsmarker").removeAttr("checked"),$("#sizemarkerdiv").slideUp(),$("[data-notmarker]").slideDown(),$('[for="puertaCordsEdificio"]').text("Punto de entrada:"),$("#hidename").slideDown(),$("#btnOpenGalery").slideUp()}y||(F.classList.contains("show")?b.hide():b.show())}),t=o("OSMgo",'<i class="fa-solid fa-book-atlas"></i>',"Editar en OpenStreetMaps",()=>{const e="https://www.openstreetmap.org/edit#map=17/25.55684/-100.93548";window.open(e,"_blank","noopener,noreferrer")}),a=o("importmap",'<div class="mapboxgl-ctrl-icon"><i class="fa-solid fa-cloud-arrow-up"></i></div>',"Importar y Exportar",()=>{var e=new mdb.Modal(document.getElementById("importInMap"));e.show()});this._container.appendChild(t),this._container.appendChild(a),this._container.appendChild(e)}return this._container}}l&&(e(l),o(l));const z=new MapboxDirections({accessToken:mapboxgl.accessToken,unit:"metric",profile:"mapbox/walking",controls:{inputs:!1,instructions:!1,profileSwitcher:!1},alternatives:!0,interactive:!1});w.addControl(new P,"top-right"),w.getCanvas().style.cursor="default",w.on("dragstart",()=>a("move")),w.on("dragend",()=>a("default")),w.on("mousedown",()=>a("pointer")),w.on("mouseup",()=>a("default")),w.on("mouseover",()=>a("default")),s.classList.contains("map_user")&&w.on("click",function(e){const o=e.lngLat;n(o)}),c.forEach(a=>{a.addEventListener("click",function(a){const n=a.target.id;e(n),t(),o(n)})});const T=document.querySelector("#map").getAttribute("data-mapa_markers");fetch(T).then(e=>e.json()).then(e=>{function o(){e.forEach(e=>{const o=e.nombre.replace(" ","");w.getSource(e.uuid)||w.addSource(e.uuid,{type:"geojson",data:{type:"FeatureCollection",features:[{type:"Feature",properties:{uuid:e.uuid,nombre:e.nombre,imagen:e.imagen,ismarker:e.ismarker,icon_size:e.icon_size,sizemarker:e.sizemarker,edges:[[e.edges[0],e.edges[1],e.edges[2],e.edges[3]]]},geometry:{type:"Point",coordinates:e.door_coords}}]}}),w.hasImage(o)||w.loadImage(e.imagen,(e,t)=>{if(e)throw e;w.addImage(o,t)}),w.getLayer(`points${o}`)||w.addLayer({id:`points${o}`,type:"symbol",source:e.uuid,layout:{"icon-image":o,"icon-size":e.icon_size,"icon-allow-overlap":!0}})})}w.on("load",()=>{o()}),w.on("style.load",()=>{o()}),w.on("click",o=>{if(s.classList.contains("map_editing")){const n=w.queryRenderedFeatures(o.point,{layers:e.map(e=>`points${e.nombre.replace(" ","")}`)});if(n.length){const e=n[0],{nombre:o,imagen:i,uuid:r,ismarker:s,icon_size:l,edges:c}=e.properties,d=e.geometry.coordinates.slice(),u=document.getElementById("offcanvasContent");document.getElementById("imagen_actual").src=i,$("#btnDeletedPleace").show(),$("[data-namePleace]").text(o),u.querySelector("#isNewEdif").value="notnew",s?($("#ismarker").val("True"),$("#checkIsmarker").attr("checked","checked"),$("#sizemarkerdiv").slideDown("fast"),$("[data-notmarker]").slideUp(),$('[for="puertaCordsEdificio"]').text("Ubicacion:")):($("#ismarker").val("False"),$("#checkIsmarker").removeAttr("checked")),$("#hidename").slideUp(),$("[data-uuid]").addClass("active").val(r),$("#nombreEdificio").addClass("active").val(o),$("#sizemarker").addClass("active").val(l),$("#puertaCordsEdificio").addClass("active").val(`${d}`),$('[for="fotoEdificio"]').html('Cambiar foto <i class="fa-regular fa-image ms-1"></i>'),$("#fotoEdificio").attr("required",!1),$("#esquina1").addClass("active").val(c[0]),$("#esquina2").addClass("active").val(c[1]),$("#esquina3").addClass("active").val(c[2]),$("#esquina4").addClass("active").val(c[3]);var t=document.getElementById("pleaceGalery"),a=bootstrap.Offcanvas.getInstance(t);a&&a.hide(),b.show(),y=!0}}})}).catch(e=>{console.error("Error al obtener Marcadores del mapa:"),console.error(e),alertSToast("top",5e3,"error","Ocurrio un error inesperado. #403")});const U=document.querySelector("#map").getAttribute("data-mapa_edif");fetch(U).then(e=>e.json()).then(e=>{function o(){w.getSource("places")||w.addSource("places",{type:"geojson",data:i}),w.getLayer("places-layer")||w.addLayer({id:"places-layer",type:"fill",source:"places",paint:{"fill-color":["get","color"],"fill-opacity":.4}}),w.getLayer("places-label")||(w.addLayer({id:"places-label",type:"symbol",source:"places",layout:{"text-field":["get","label"],"text-size":12,"text-offset":[0,-.6],"text-anchor":"top"},paint:{"text-color":f}}),w.moveLayer("places-label"))}function t(){const e=m.value,o=p.value;if(e&&o&&e!==o){const t=i.features.find(o=>o.properties.nombre===e),n=i.features.find(e=>e.properties.nombre===o);if(t&&n){const e=t.properties.door,o=n.properties.door;z.setOrigin(e),z.setDestination(o),$("#buttons_route").slideDown("slow"),z.on("route",e=>{const o={type:"FeatureCollection",features:e.route.map(e=>({type:"Feature",geometry:e.geometry,properties:{}}))};g=o;const t=e.route[0].distance/1e3,a=e.route[0].duration/60;$("#route-info").html(`<div class="row mb-2"><div class="col-1"><i class="fa-solid fa-shoe-prints me-1"></i></div><div class="col">Distancia: <strong>${t.toFixed(2)} km</strong></div></div><div class="row"><div class="col-1"><i class="fa-solid fa-hourglass-half me-1"></i></div><div class="col">Duración: <strong>${a.toFixed(2)} minutos aprox.</strong></div></div>`),$("#route-info").slideDown()}),window.innerWidth<=800&&setTimeout(()=>{$("#controls_route").removeClass("show")},4e3),w.addControl(z,"top-left"),w.moveLayer("places-label"),a()}}else alertSToast("center",5e3,"warning","Por favor, selecciona tanto origen como destino.")}function a(){if(g&&g.features&&g.features.length>0){w.getSource("directions")||w.addSource("directions",{type:"geojson",data:g});const e=g.features.find(e=>"origin"===e.properties.id),o=g.features.find(e=>"destination"===e.properties.id);w.getLayer("directions-route-line")||w.addLayer({id:"directions-route-line",type:"line",source:"directions",layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#2d5f99","line-width":12},filter:["==","$type","LineString"]}),w.getLayer("directions-route-line-alt")||w.addLayer({id:"directions-route-line-alt",type:"line",source:"directions",layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#4882c5","line-width":6},filter:["==","$type","LineString"]}),w.getLayer("directions-origin-point")||w.addLayer({id:"directions-origin-point",type:"circle",source:"directions",paint:{"circle-color":"#3bb2d0","circle-radius":20},filter:["==",["get","id"],"origin"]}),w.getLayer("directions-destination-point")||w.addLayer({id:"directions-destination-point",type:"circle",source:"directions",paint:{"circle-color":"#8a8bc9","circle-radius":20},filter:["==",["get","id"],"destination"]}),w.getLayer("directions-origin-label")||(console.log(e.properties["marker-symbol"]),w.addLayer({id:"directions-origin-label",type:"symbol",source:"directions",layout:{"text-field":e.properties["marker-symbol"],"text-font":["Open Sans Bold","Arial Unicode MS Bold"],"text-size":18},paint:{"text-color":"#fff"},filter:["==",["get","id"],"origin"]})),w.getLayer("directions-destination-label")||w.addLayer({id:"directions-destination-label",type:"symbol",source:"directions",layout:{"text-field":o.properties["marker-symbol"],"text-font":["Open Sans Bold","Arial Unicode MS Bold"],"text-size":18},paint:{"text-color":"#fff"},filter:["==",["get","id"],"destination"]}),w.moveLayer("places-label")}}function n(){const e=new URLSearchParams(window.location.search);return{origin:e.get("origin"),destiny:e.get("destiny")}}const i={type:"FeatureCollection",features:e.map(e=>({type:"Feature",properties:{uuid:e.uuid,color:e.color,label:e.hidename?"":e.nombre,nombre:e.nombre,door:e.door_coords,ismarker:e.ismarker,imagen_url:e.imagen_url,informacion:e.informacion,galery_count:e.galery_count,galery_items:e.galery_items},geometry:{type:"Polygon",coordinates:[[e.polygons[0],e.polygons[1],e.polygons[2],e.polygons[3],e.polygons[0]]]}}))};w.on("load",function(){o()}),w.on("style.load",function(){o(),a()}),w.on("click","places-layer",e=>{const o=e.features[0],{nombre:t,informacion:a,imagen_url:n,galery_count:i,galery_items:r}=o.properties,{coordinates:l}=o.geometry,c=document.getElementById("offcanvasContent");if(document.getElementById("imagen_actual").src=`/media/${n}`,s.classList.contains("map_user"))document.getElementById("lateralTitle").innerText=t,c.innerHTML=`<div class="feature-info"><p>${a}</p></div>`;else if(s.classList.contains("map_editing")){$("#offcanvasContent input").removeClass("active is-invalid is-valid").val(""),$(".error.bg-danger").slideUp("fast");const{color:e,door:n,uuid:r,ismarker:s,label:c}=o.properties;$("#checkIsmarker").is(":checked")&&($("#sizemarkerdiv").slideUp(),$("[data-notmarker]").slideDown(),$('[for="puertaCordsEdificio"]').text("Punto de entrada:")),$("#btnDeletedPleace").show(),$("#btnOpenGalery").slideDown(),$("[data-namePleace]").text(t),$("#galeryCount").text(i),$("#isNewEdif").val("notnew"),$("#sizemarker").val("0.5"),s?($("#ismarker").val("True"),$("#checkIsmarker").attr("checked","checked")):($("#ismarker").val("False"),$("#checkIsmarker").removeAttr("checked")),$("#hidename").slideDown(),""!=c?$("#hidename").attr("checked","checked"):$("#hidename").removeAttr("checked"),$("[data-uuid]").addClass("active").val(r),$("#nombreEdificio").addClass("active").val(t),$(".name_pleace").text(t),$("#namecolor").addClass("active").val(e);const d=n.slice(1,-1).split(",");$("#puertaCordsEdificio").addClass("active").val(`${d[0]},${d[1]}`),$("#esquina1").addClass("active").val(l[0][0]),$("#esquina2").addClass("active").val(l[0][1]),$("#esquina3").addClass("active").val(l[0][2]),$("#esquina4").addClass("active").val(l[0][3]),$('[for="fotoEdificio"]').html('Cambiar foto <i class="fa-regular fa-image ms-1"></i>'),$("#fotoEdificio").attr("required",!1),tinymce.get("textTiny").setContent(a),L()}b.show(),y=!0});const r=i.features.map(e=>e.properties.nombre).sort();r.forEach(e=>{const o=new Option(e,e);document.getElementById("origen").add(o),document.getElementById("destino").add(o.cloneNode(!0))}),m.addEventListener("change",function(){const e=this.value;p.querySelectorAll("option").forEach(o=>{o.disabled=o.value===e});const o=new URLSearchParams(window.location.search);o.set("origin",e),history.replaceState({},"",`${location.pathname}?${o}`),p.value&&t()}),p.addEventListener("change",function(){const e=this.value;m.querySelectorAll("option").forEach(o=>{o.disabled=o.value===e});const o=new URLSearchParams(window.location.search);o.set("destiny",e),history.replaceState({},"",`${location.pathname}?${o}`),m.value&&t()});const{origin:l,destiny:c}=n();if(l&&c&&l!==c){const e=i.features.find(e=>e.properties.nombre===l),o=i.features.find(e=>e.properties.nombre===c);if(e&&o){const e=m.querySelector(`option[value="${l}"]`),o=p.querySelector(`option[value="${c}"]`);e&&(e.selected=!0,m.dispatchEvent(new Event("change"))),setTimeout(()=>{o&&(o.selected=!0,p.dispatchEvent(new Event("change"))),t()},1e3)}}document.querySelector("[data-reset_form]").addEventListener("click",function(){u.querySelectorAll("option").forEach(e=>{e.disabled=!1});const e=["directions-route-line","directions-route-line-alt","directions-route-line-casing","directions-hover-point-casing","directions-hover-point","directions-waypoint-point-casing","directions-waypoint-point","directions-origin-point","directions-origin-label","directions-destination-point","directions-destination-label"];e.forEach(e=>{w.getLayer(e)&&w.removeLayer(e)}),w.getSource("directions")&&w.removeSource("directions"),$("#buttons_route").slideUp("slow"),$("#route-info").slideUp("slow",()=>{$("#route-info").empty()});const o=new URLSearchParams(window.location.search);o.delete("origin"),o.delete("destiny"),history.replaceState({},"",`${location.pathname}?${o.toString()}`)})}).catch(e=>{console.error("Error al obtener lugares del mapa:"),console.error(e),alertSToast("top",5e3,"error","Ocurrio un error inesperado. #403")});const j=new MapboxDraw({displayControlsDefault:!1,controls:{polygon:!0,trash:!0},defaultMode:"draw_polygon"});w.addControl(j),w.on("draw.create",i),w.on("draw.delete",i),w.on("draw.update",i)});